name: Build and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

jobs:
  build-verify:
    name: Verify Build
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image (verification only)
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: mixtape-battle-app:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Build summary
        run: |
          echo "## âœ… Build Verified" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Docker image built successfully." >> $GITHUB_STEP_SUMMARY
          echo "Deployment will proceed on self-hosted runner..." >> $GITHUB_STEP_SUMMARY

  deploy:
    name: Deploy to Production
    runs-on: self-hosted
    needs: build-verify
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read

    steps:
      - name: Deploy to production
        shell: pwsh
        run: |
          Write-Host "ðŸš€ Deploying to production..."
          Set-Location "C:\Users\tim\Desktop\Windsurf Projects\mixtape-battle"
          .\deploy.ps1
          
      - name: Deployment Summary
        shell: pwsh
        run: |
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "## ðŸš€ Deployment Complete"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ""
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "Production has been updated with commit ``${{ github.sha }}``"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value ""
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "**Branch:** ``${{ github.ref_name }}``"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "**Commit:** ``${{ github.sha }}``"
          Add-Content -Path $env:GITHUB_STEP_SUMMARY -Value "**Triggered by:** ${{ github.actor }}"
