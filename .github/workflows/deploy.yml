name: Build and Deploy

on:
  push:
    branches:
      - main
  workflow_dispatch: # Allow manual trigger

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix={{date 'YYYYMMDD'}}-
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Generate deployment artifact
        run: |
          mkdir -p deployment
          echo "IMAGE_TAG=$(echo ${{ steps.meta.outputs.tags }} | cut -d',' -f1)" > deployment/image.env
          echo "DEPLOYED_AT=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> deployment/image.env
          echo "COMMIT_SHA=${{ github.sha }}" >> deployment/image.env
          echo "COMMIT_MESSAGE=$(git log -1 --pretty=%B)" >> deployment/commit.txt

      - name: Upload deployment info
        uses: actions/upload-artifact@v4
        with:
          name: deployment-info
          path: deployment/
          retention-days: 30

  notify:
    needs: build
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Download deployment info
        uses: actions/download-artifact@v4
        with:
          name: deployment-info
          path: deployment/
        continue-on-error: true

      - name: Deployment summary
        run: |
          echo "## ðŸš€ Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.build.result }}" == "success" ]; then
            echo "âœ… **Build Successful**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Next Steps:**" >> $GITHUB_STEP_SUMMARY
            echo "1. SSH into production server" >> $GITHUB_STEP_SUMMARY
            echo "2. Run deployment script: \`./deploy.sh\`" >> $GITHUB_STEP_SUMMARY
            echo "3. Verify deployment at https://mixtape.levesques.net" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ -f deployment/image.env ]; then
              echo "**Image Details:**" >> $GITHUB_STEP_SUMMARY
              cat deployment/image.env >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âŒ **Build Failed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
          fi
